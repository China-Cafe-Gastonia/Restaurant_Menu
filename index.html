<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
        }
        .menu-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container">
        <!-- Restaurant Info -->
        <header id="restaurantInfo" class="text-center pb-6">
            <h1 id="restaurantName" class="text-4xl font-bold text-orange-600 mb-2"></h1>
            <p id="restaurantLocation" class="text-gray-500"></p>
            <p id="restaurantHours" class="text-gray-500"></p>
            <p id="restaurantPhone" class="text-gray-500"></p>
        </header>
        
        <!-- Menu Categories -->
        <main id="menuContainer" class="grid gap-8">
            <div id="loading" class="text-center font-semibold text-gray-500 mt-12">Loading menu...</div>
            <div id="no-items" class="hidden text-center font-semibold text-gray-500 mt-12">No menu items available. Please check back later.</div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Log all Firebase debug messages
        setLogLevel('debug');

        // Global variables for Firebase configuration provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const menuContainer = document.getElementById('menuContainer');
        const loadingMessage = document.getElementById('loading');
        const noItemsMessage = document.getElementById('no-items');

        const restaurantName = document.getElementById('restaurantName');
        const restaurantLocation = document.getElementById('restaurantLocation');
        const restaurantHours = document.getElementById('restaurantHours');
        const restaurantPhone = document.getElementById('restaurantPhone');

        let db;
        let auth;
        let userId = '';

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || 'anonymous';
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                loadingMessage.textContent = 'Failed to connect to Firebase. Check console for details.';
            }
        }

        // Fetch static restaurant data from JSON
        async function fetchRestaurantData() {
            try {
                const response = await fetch("uploaded:09.16.2025.json");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.restaurant) {
                    restaurantName.textContent = data.restaurant.name;
                    restaurantLocation.textContent = data.restaurant.location;
                    restaurantHours.textContent = data.restaurant.hours;
                    restaurantPhone.textContent = data.restaurant.phone;
                }
            } catch (error) {
                console.error("Error fetching restaurant data:", error);
            }
        }
        
        // Render menu items dynamically
        function renderMenu(items) {
            menuContainer.innerHTML = ''; // Clear the container

            if (items.length === 0) {
                noItemsMessage.classList.remove('hidden');
                return;
            }

            noItemsMessage.classList.add('hidden');
            
            const categories = items.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            for (const category in categories) {
                const categoryCard = document.createElement('div');
                categoryCard.className = 'menu-card';
                categoryCard.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">${category}</h2>
                    <ul class="space-y-6">
                        ${categories[category].map(item => `
                            <li class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-gray-900">${item.name}</p>
                                    <p class="text-sm text-gray-500 italic">${item.chinese_name}</p>
                                    <p class="text-gray-600 text-sm mt-1">${item.description}</p>
                                </div>
                                <span class="font-bold text-orange-600 text-lg ml-4 flex-shrink-0">$${item.price.toFixed(2)}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                menuContainer.appendChild(categoryCard);
            }
        }

        // Listen for real-time menu updates from Firestore
        async function listenForMenuUpdates() {
            if (!db) {
                console.log("Database not initialized, retrying...");
                await new Promise(resolve => setTimeout(resolve, 500));
                return listenForMenuUpdates();
            }

            const menuRef = collection(db, `artifacts/${appId}/public/data/menu_data`);
            
            onSnapshot(menuRef, (querySnapshot) => {
                const menuItems = [];
                querySnapshot.forEach((doc) => {
                    menuItems.push(doc.data());
                });
                renderMenu(menuItems);
                loadingMessage.classList.add('hidden');
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                loadingMessage.textContent = 'Error fetching menu data.';
            });
        }
        
        // Initial setup on window load
        window.onload = async () => {
            await initializeFirebase();
            await fetchRestaurantData();
            listenForMenuUpdates();
        };

    </script>
</body>
</html>
