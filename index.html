<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 2rem;
        }
        .menu-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .category-header {
            display: flex;
            align-items: center;
            font-size: 2rem;
            font-weight: 800;
            color: #1e293b;
            background: linear-gradient(90deg, #fef9c3 0%, #f0fdf4 100%);
            border-left: 8px solid #fbbf24;
            border-radius: 0.5rem 0 0 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            margin-top: -1rem;
        }
        .category-chinese {
            font-size: 1.25rem;
            color: #64748b;
            margin-left: 1rem;
            font-weight: 600;
        }
        .category-note {
            margin-bottom: 0.5rem;
            color: #2563eb;
            font-size: 1rem;
        }
        #restaurantName {
            font-size: 2.75rem;
            font-weight: 900;
            color: #be123c;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #fca5a5;
        }
        .hours-block {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            width: 100%;
        }
        .hours-lines {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            align-items: center;
        }
        .hours-icon {
            font-size: 1.3rem;
            margin-right: 0.5rem;
            margin-top: 0.1rem;
        }
        .hours-title {
            font-weight: 900;
            color: #2563eb;
            margin-right: 0.5rem;
        }
        .hours-lines {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
        }
        .important-note-box {
            display: flex;
            align-items: flex-start;
            background: linear-gradient(90deg, #fef9c3 0%, #f0fdf4 100%);
            border-left: 8px solid #fbbf24;
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            font-size: 1.15rem;
            font-weight: 600;
            color: #b91c1c;
            box-shadow: 0 2px 8px 0 #fbbf2433;
        }
        .important-note-icon {
            font-size: 1.6rem;
            margin-right: 0.75rem;
            margin-top: 0.1rem;
        }
        .important-note-title {
            color: #b91c1c;
            font-weight: 900;
            margin-right: 0.5rem;
        }
        .important-note-text {
            color: #1e293b;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mt-12">
        <header class="text-center mb-8">
            <h1 id="restaurantName" class="text-4xl font-extrabold text-gray-900"></h1>
            <div id="restaurantInfo" class="text-lg text-gray-600 mt-2"></div>
            <div id="restaurantNotes" class="mt-4"></div>
        </header>

        <div id="loadingMessage" class="text-center text-gray-500 text-lg">
            Loading menu...
        </div>

        <div id="menuContainer">
            </div>
    </div>

    
    <div class="text-center mt-8">
        <a href="admin.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out shadow-md">Go to Admin Page</a>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Helper: flatten any nested `unit` arrays into array of objects {size, option, price}
        function flattenUnitField(unit) {
            if (!Array.isArray(unit)) return unit;
            if (unit.length > 0 && typeof unit[0] === 'object' && (unit[0].size !== undefined || unit[0].price !== undefined)) {
                return unit; // already flattened
            }
            const out = [];
            unit.forEach(entry => {
                if (!Array.isArray(entry)) {
                    out.push({ size: entry, option: null, price: null });
                    return;
                }
                const size = entry[0];
                const second = entry[1];
                if (Array.isArray(second)) {
                    second.forEach(opt => {
                        if (Array.isArray(opt)) {
                            out.push({ size: size, option: opt[0], price: opt[1] });
                        } else {
                            out.push({ size: size, option: opt, price: null });
                        }
                    });
                } else {
                    out.push({ size: size, option: null, price: second });
                }
            });
            return out;
        }

        function normalizeMenuItem(item) {
            if (!item || typeof item !== 'object') return item;
            const copy = { ...item };
            if (copy.unit) {
                try {
                    copy.unit = flattenUnitField(copy.unit);
                } catch (e) {
                    console.warn('Failed to flatten unit for item', item, e);
                }
            }
            return copy;
        }

        function formatPrice(val) {
            if (val === null || val === undefined || val === '') return '';
            const n = Number(val);
            if (Number.isFinite(n)) return `$${n.toFixed(2)}`;
            return '';
        }

        // IMPORTANT: REPLACE WITH YOUR OWN FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBEFimTV6zygaMki5VZQ9cqdcFTfPMaOj0",
            authDomain: "china-cafe-menu.firebaseapp.com",
            projectId: "china-cafe-menu",
            storageBucket: "china-cafe-menu.firebasestorage.app",
            messagingSenderId: "233511471732",
            appId: "1:233511471732:web:e2298d04ff590dcdd6df21",
        };
        const appId = firebaseConfig.appId;

        let db;

        async function fetchRestaurantData() {
            // Only fetch restaurant info/notes from Firestore in the future, or remove this if not needed
            // For now, clear info/notes
            document.getElementById('restaurantName').textContent = '';
            document.getElementById('restaurantInfo').innerHTML = '';
            document.getElementById('restaurantNotes').innerHTML = '';
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase initialized successfully.");
            } catch (error) {
                console.error("Failed to connect to Firebase:", error);
                document.getElementById('loadingMessage').textContent = 'Failed to connect to Firebase. Check console for details.';
            }
        }

        function renderMenu(menuItems) {
            const menuContainer = document.getElementById('menuContainer');
            menuContainer.innerHTML = '';
            // Separate _info doc and menu items
            let restaurant = null;
            let notes = null;
            let menuDocs = [];
            for (const item of menuItems) {
                if (item._id === '_info') {
                    if (item.restaurant) restaurant = item.restaurant;
                    if (item.notes) notes = item.notes;
                } else {
                    menuDocs.push(item);
                }
            }
            // Render restaurant info (unchanged)
            const nameEl = document.getElementById('restaurantName');
            const infoEl = document.getElementById('restaurantInfo');
            const notesEl = document.getElementById('restaurantNotes');
            if (restaurant) {
                nameEl.textContent = restaurant.name || '';
                // ...existing code for hours and info rendering...
                function formatHours(hours) {
                    if (typeof hours === 'string') {
                        return `<span class='block'><b>Hours:</b> ${hours}</span>`;
                    }
                    const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
                    const groups = [];
                    let last = null, group = [];
                    for (const day of days) {
                        const h = hours[day];
                        const key = h && h.open && h.close ? `${h.open}-${h.close}` : "Closed";
                        if (!last || last !== key) {
                            if (group.length) groups.push({days: group, key: last});
                            group = [day];
                            last = key;
                        } else {
                            group.push(day);
                        }
                    }
                    if (group.length) groups.push({days: group, key: last});
                    return `<div class="flex flex-col items-center justify-center mt-2 mb-2">
                        <div class="flex items-center justify-center mb-1">
                            <span class="hours-icon">🕒</span>
                            <span class="hours-title text-lg" style="font-size:1.2rem;"><b>Hours:</b></span>
                        </div>
                        <div class="flex flex-col items-center">
                            ${groups.map(g => {
                                const label = g.days.length > 1
                                    ? `<b>${g.days[0].slice(0,3)} - ${g.days[g.days.length-1].slice(0,3)}:</b>`
                                    : `<b>${g.days[0].slice(0,3)}:</b>`;
                                return `<div class="text-base" style="margin-bottom:2px;">${label} ${g.key === 'Closed' ? '<span style=\"color:#b91c1c;font-weight:600;\">Closed</span>' : g.key.replace('-', ' - ')}</div>`;
                            }).join('')}
                        </div>
                    </div>`;
                }
                let formattedHours = '';
                if (restaurant.hours) {
                    formattedHours = formatHours(restaurant.hours);
                }
                infoEl.innerHTML = [
                    restaurant.location ? `<span class='block'><b>Address:</b> ${restaurant.location}</span>` : '',
                    restaurant.phone ? `<span class='block'><b>Phone:</b> ${restaurant.phone}</span>` : '',
                    formattedHours
                ].filter(Boolean).join('');
            } else {
                nameEl.textContent = '';
                infoEl.innerHTML = '';
            }
    if (notes) {
        let notesHtml = '';
        if (notes.combination_plate) {
            notesHtml += `
                <div class="important-note-box">
                    <span class="important-note-icon">🍱</span>
                    <span class="important-note-title">Combo Plate:</span>
                    <span class="important-note-text">${notes.combination_plate}</span>
                </div>
            `;
        }
        if (notes.lunch_special) {
            notesHtml += `
                <div class="important-note-box">
                    <span class="important-note-icon">⏰</span>
                    <span class="important-note-title">Lunch Special:</span>
                    <span class="important-note-text">${notes.lunch_special}</span>
                </div>
            `;
        }
        notesEl.innerHTML = notesHtml;
    } else {
        notesEl.innerHTML = '';
    }
            if (!menuDocs || menuDocs.length === 0) {
                menuContainer.innerHTML = '<div class="text-center text-gray-400 text-xl py-12">Menu not available or under maintenance.</div>';
                return;
            }
            // Sort menuDocs by categoryOrder and itemOrder if present
            menuDocs = menuDocs.slice();
            menuDocs.sort((a, b) => {
                if (typeof a.categoryOrder === 'number' && typeof b.categoryOrder === 'number') {
                    if (a.categoryOrder !== b.categoryOrder) return a.categoryOrder - b.categoryOrder;
                    if (typeof a.itemOrder === 'number' && typeof b.itemOrder === 'number') {
                        return a.itemOrder - b.itemOrder;
                    }
                }
                return 0;
            });
            // Group by category (now in correct order)
            const groupedMenu = menuDocs.reduce((acc, item) => {
                (acc[item.category] = acc[item.category] || []).push(item);
                return acc;
            }, {});
            for (const category in groupedMenu) {
                const categoryCard = document.createElement('div');
                categoryCard.classList.add('menu-card');
                // Get meta info from first item in category
                const firstItem = groupedMenu[category][0] || {};
                const chineseName = firstItem.chinese_name || '';
                const note = firstItem.note || '';
                categoryCard.innerHTML = `
                    <div class="category-header">
                        ${category}
                        ${chineseName ? `<span class='category-chinese'>${chineseName}</span>` : ''}
                    </div>
                    ${note ? `<div class='category-note'>${note}</div>` : ''}
                    <ul class="space-y-4">
                        ${groupedMenu[category].map(item => {
                            // Only support array-based unit fields
                            let detailsHtml = '';
                            if (Array.isArray(item.unit)) {
                                detailsHtml += item.unit.map(u => {
                                    if (typeof u === 'object' && u !== null) {
                                        // Show size and option if present
                                        let label = '';
                                        if (u.size) label += `<span>${u.size}</span>`;
                                        if (u.option) label += label ? ` - <span>${u.option}</span>` : `<span>${u.option}</span>`;
                                        return `<div class="flex justify-between"><span class="text-sm text-gray-700">${label}</span><span class="text-orange-600 font-semibold">$${parseFloat(u.price).toFixed(2)}</span></div>`;
                                    } else if (typeof u === 'string' || typeof u === 'number') {
                                        return `<span class="text-sm text-gray-700">${u}</span>`;
                                    }
                                    return '';
                                }).join('');
                            }
                            // Fallback for price/prices
                            if (!detailsHtml) {
                                if (typeof item.price !== 'undefined') {
                                    detailsHtml = `<span class="text-orange-600 font-semibold">$${parseFloat(item.price).toFixed(2)}</span>`;
                                } else if (item.prices && typeof item.prices === 'object') {
                                    detailsHtml = Object.entries(item.prices).map(([k, v]) => `<div class="flex justify-between"><span class="text-sm text-gray-500">${k}</span><span class="text-orange-600">$${parseFloat(v).toFixed(2)}</span></div>`).join('');
                                } else if (typeof item.prices === 'string' || typeof item.prices === 'number') {
                                    detailsHtml = `<span class="text-orange-600 font-semibold">$${parseFloat(item.prices).toFixed(2)}</span>`;
                                }
                            }
                            return `
                            <li class="border-b pb-2">
                                <div class="flex-grow">
                                    <h3 class="text-lg font-semibold text-gray-800">${item.name}</h3>
                                    <p class="text-sm text-gray-500 mb-1">${item.description || ''}</p>
                                    ${detailsHtml ? `<div class="space-y-1">${detailsHtml}</div>` : ''}
                                </div>
                            </li>
                            `;
                        }).join('')}
                    </ul>
                `;
                menuContainer.appendChild(categoryCard);
            }
        }

        async function listenForMenuUpdates() {
            if (!db) {
                console.log("Database not initialized, retrying...");
                await new Promise(resolve => setTimeout(resolve, 500));
                return listenForMenuUpdates();
            }

            const menuRef = collection(db, `artifacts/${appId}/public/data/menu_data`);
            onSnapshot(menuRef, (querySnapshot) => {
                // If using Firestore, expect flat array
                let menuItems = [];
                querySnapshot.forEach((doc) => {
                    menuItems.push({ ...doc.data(), _id: doc.id });
                });
                // Normalize items to support both legacy nested-array and new flattened shapes
                menuItems = menuItems.map(normalizeMenuItem);
                renderMenu(menuItems);
                document.getElementById('loadingMessage').classList.add('hidden');
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                document.getElementById('loadingMessage').textContent = 'Error fetching menu data.';
            });
        }

        window.onload = async () => {
            await initializeFirebase();
            await fetchRestaurantData();
            listenForMenuUpdates();
        };
    </script>
</body>
</html>