<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 600px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mt-12">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Restaurant Admin Console</h1>
            <p class="text-gray-500">Manage your menu data in Firestore</p>
        </header>

        <!-- Login Form -->
        <div id="loginCard" class="card">
            <h2 class="text-2xl font-semibold mb-4">Admin Login</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="adminEmail" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="adminPassword" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                </div>
                <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-blue-700 transition-colors w-full">Login</button>
            </form>
            <div id="loginStatus" class="mt-4 text-sm font-medium"></div>
        </div>

        <!-- Admin UI (hidden until logged in) -->
        <div id="adminCard" class="card" style="display:none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Menu Management</h2>
                <button id="logoutButton" class="bg-gray-300 text-gray-800 font-semibold py-1 px-4 rounded-full shadow hover:bg-gray-400">Logout</button>
            </div>
            <p class="mb-4 text-gray-600">
                Upload a JSON file to update your menu or delete the entire menu from Firestore.<br>
                Or edit menu items below.
            </p>
            <div class="mb-4">
                <label for="jsonFile" class="block text-sm font-medium text-gray-700">Select Menu JSON File</label>
                <input type="file" id="jsonFile" accept=".json" class="mt-1 block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100">
            </div>
            <div class="flex space-x-4 mb-4">
                <button id="uploadButton" class="bg-orange-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-orange-600 transition-colors">
                    Upload Menu
                </button>
                <button id="deleteButton" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-red-600 transition-colors">
                    Delete Menu
                </button>
                <button id="loadMenuButton" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-full shadow-md hover:bg-blue-600 transition-colors">
                    Load Menu
                </button>
            </div>
            <div id="statusMessage" class="mt-6 text-sm font-medium"></div>
            <div id="menuEditSection" class="mt-8"></div>
        </div>
    </div>

    <script type="module">

    // Helper: Render menu edit table
    function renderMenuEditTable(menuItems) {
        const section = document.getElementById('menuEditSection');
        if (!menuItems || menuItems.length === 0) {
            section.innerHTML = '<div class="text-gray-500">No menu items loaded.</div>';
            return;
        }
        // Group items by category
        const groupedMenu = menuItems.reduce((acc, item, idx) => {
            (acc[item.category] = acc[item.category] || []).push({ ...item, _idx: idx });
            return acc;
        }, {});
        let html = '';
        for (const category in groupedMenu) {
            html += `<div class="menu-card mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4 flex items-center">
                    <input type="text" value="${category}" data-category-edit="${category}" class="font-bold text-gray-900 bg-gray-100 rounded px-2 py-1 mr-2" style="min-width:120px;" />
                </h2>
                <ul class="space-y-4">`;
            groupedMenu[category].forEach((item, idxInCat) => {
                html += `
                <li class="flex justify-between items-center border-b pb-2">
                    <div class="flex-grow flex flex-col gap-1">
                        <input type="text" class="text-lg font-semibold text-gray-800 bg-gray-50 rounded px-2 py-1 mb-1 w-full" value="${item.name || ''}" data-field="name" data-idx="${item._idx}">
                        <input type="text" class="text-sm text-gray-500 bg-gray-50 rounded px-2 py-1 w-full" value="${item.description || ''}" data-field="description" data-idx="${item._idx}">
                    </div>
                    <div class="flex flex-col items-end ml-4">
                        <input type="number" step="0.01" class="text-orange-600 text-lg bg-gray-50 rounded px-2 py-1 w-24 mb-1" value="${item.price || ''}" data-field="price" data-idx="${item._idx}">
                        <div class="flex gap-1">
                            <button class="bg-green-500 text-white px-2 py-1 rounded saveMenuItemBtn" data-idx="${item._idx}">Save</button>
                            <button class="bg-red-500 text-white px-2 py-1 rounded deleteMenuItemBtn" data-idx="${item._idx}">Delete</button>
                        </div>
                        <div class="flex gap-1 mt-1">
                            <button class="bg-blue-200 text-blue-800 px-2 py-1 rounded addAboveMenuItemBtn" data-idx="${item._idx}">Add Above</button>
                            <button class="bg-blue-200 text-blue-800 px-2 py-1 rounded addBelowMenuItemBtn" data-idx="${item._idx}">Add Below</button>
                        </div>
                    </div>
                </li>`;
            });
            // Add new item to this category
            html += `<li class="flex justify-between items-center pt-4">
                <div class="flex-grow flex flex-col gap-1">
                    <input type="text" class="text-lg font-semibold text-gray-800 bg-gray-50 rounded px-2 py-1 mb-1 w-full" id="newName-${category}">
                    <input type="text" class="text-sm text-gray-500 bg-gray-50 rounded px-2 py-1 w-full" id="newDescription-${category}">
                </div>
                <div class="flex flex-col items-end ml-4">
                    <input type="number" step="0.01" class="text-orange-600 text-lg bg-gray-50 rounded px-2 py-1 w-24 mb-1" id="newPrice-${category}">
                    <button class="bg-blue-500 text-white px-2 py-1 rounded" data-category="${category}" id="addMenuItemBtn-${category}">Add</button>
                </div>
            </li>`;
            html += '</ul></div>';
        }
        section.innerHTML = html;
    }

    // Load menu from Firestore and render edit table
    let loadedMenuItems = [];
    document.getElementById('loadMenuButton').addEventListener('click', async () => {
        statusMessage.textContent = 'Loading menu...';
        try {
            const menuRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/menu_data`);
            const snapshot = await getDocs(menuRef);
            loadedMenuItems = [];
            snapshot.forEach(docSnap => {
                loadedMenuItems.push({ ...docSnap.data(), _id: docSnap.id });
            });
            renderMenuEditTable(loadedMenuItems);
            statusMessage.textContent = 'Menu loaded.';
        } catch (e) {
            statusMessage.textContent = 'Error loading menu: ' + e.message;
        }
    });

    // Delegate save/delete/add actions
    document.getElementById('menuEditSection').addEventListener('click', async (e) => {
        if (e.target.classList.contains('saveMenuItemBtn')) {
            const idx = e.target.getAttribute('data-idx');
            const item = loadedMenuItems[idx];
            // Get updated values
            const row = e.target.closest('tr');
            item.name = row.querySelector('input[data-field="name"]').value;
            item.description = row.querySelector('input[data-field="description"]').value;
            item.category = row.querySelector('input[data-field="category"]').value;
            item.price = parseFloat(row.querySelector('input[data-field="price"]').value) || 0;
            // Save to Firestore
            try {
                const menuRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/menu_data`);
                const docRef = doc(menuRef, item._id);
                await writeBatch(db).set(docRef, item).commit();
                statusMessage.textContent = 'Item saved.';
            } catch (err) {
                statusMessage.textContent = 'Error saving item: ' + err.message;
            }
        } else if (e.target.classList.contains('deleteMenuItemBtn')) {
            const idx = e.target.getAttribute('data-idx');
            const item = loadedMenuItems[idx];
            try {
                const menuRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/menu_data`);
                const docRef = doc(menuRef, item._id);
                await writeBatch(db).delete(docRef).commit();
                loadedMenuItems.splice(idx, 1);
                renderMenuEditTable(loadedMenuItems);
                statusMessage.textContent = 'Item deleted.';
            } catch (err) {
                statusMessage.textContent = 'Error deleting item: ' + err.message;
            }
        } else if (e.target.id === 'addMenuItemBtn') {
            // Add new item
            const name = document.getElementById('newName').value;
            const description = document.getElementById('newDescription').value;
            const category = document.getElementById('newCategory').value;
            const price = parseFloat(document.getElementById('newPrice').value) || 0;
            if (!name || !category) {
                statusMessage.textContent = 'Name and category are required.';
                return;
            }
            try {
                const menuRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/menu_data`);
                const newDocRef = doc(menuRef);
                const newItem = { name, description, category, price };
                await writeBatch(db).set(newDocRef, newItem).commit();
                loadedMenuItems.push({ ...newItem, _id: newDocRef.id });
                renderMenuEditTable(loadedMenuItems);
                statusMessage.textContent = 'Item added.';
            } catch (err) {
                statusMessage.textContent = 'Error adding item: ' + err.message;
            }
        }
    });
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, getDocs, writeBatch, doc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        // IMPORTANT: REPLACE WITH YOUR OWN FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBEFimTV6zygaMki5VZQ9cqdcFTfPMaOj0",
            authDomain: "china-cafe-menu.firebaseapp.com",
            projectId: "china-cafe-menu",
            storageBucket: "china-cafe-menu.firebasestorage.app",
            messagingSenderId: "233511471732",
            appId: "1:233511471732:web:e2298d04ff590dcdd6df21"
        };
        const appId = firebaseConfig.appId;


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const auth = getAuth(app);
        // UI elements
        const loginCard = document.getElementById('loginCard');
        const loginForm = document.getElementById('loginForm');
        const loginStatus = document.getElementById('loginStatus');
        const adminCard = document.getElementById('adminCard');
        const uploadButton = document.getElementById('uploadButton');
        const deleteButton = document.getElementById('deleteButton');
        const logoutButton = document.getElementById('logoutButton');
        const statusMessage = document.getElementById('statusMessage');
        const jsonFile = document.getElementById('jsonFile');

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Show admin UI
                loginCard.style.display = 'none';
                adminCard.style.display = '';
                statusMessage.textContent = 'Firebase initialized. Ready.';
            } else {
                // Show login UI
                loginCard.style.display = '';
                adminCard.style.display = 'none';
                loginStatus.textContent = '';
                statusMessage.textContent = '';
            }
        });

        // Login form submit
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            loginStatus.textContent = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginStatus.textContent = '';
            } catch (error) {
                loginStatus.textContent = 'Login failed: ' + (error.message || error.code);
            }
        });

        // Logout button
        logoutButton.addEventListener('click', async () => {
            await signOut(auth);
        });

        // Upload a JSON file to Firestore
        uploadButton.addEventListener('click', async () => {
            if (!db || !auth.currentUser) {
                statusMessage.textContent = 'You must be logged in as admin.';
                return;
            }

            const file = jsonFile.files[0];
            if (!file) {
                statusMessage.textContent = 'Please select a JSON file to upload.';
                return;
            }

            statusMessage.textContent = 'Uploading menu...';

            try {
                const fileReader = new FileReader();
                fileReader.onload = async (event) => {
                    try {
                        let menuData = JSON.parse(event.target.result);
                        // Accept both flat array and nested format
                        if (!Array.isArray(menuData)) {
                            // Try to extract and flatten from nested format
                            if (menuData.menu && Array.isArray(menuData.menu)) {
                                // Flatten all items from all categories
                                menuData = menuData.menu.flatMap(cat =>
                                    (cat.items || []).map(item => ({ ...item, category: cat.category }))
                                );
                            } else {
                                statusMessage.textContent = 'Error: The uploaded file is not a valid JSON array or menu format.';
                                return;
                            }
                        }

                        // Reference to the collection
                        const menuRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/menu_data`);
                        // Delete all existing documents
                        const existingDocs = await getDocs(menuRef);
                        const deleteBatch = writeBatch(db);
                        existingDocs.forEach((doc) => {
                            deleteBatch.delete(doc.ref);
                        });
                        await deleteBatch.commit();

                        // Add new documents
                        const newBatch = writeBatch(db);
                        menuData.forEach(item => {
                            const newDocRef = doc(menuRef);
                            newBatch.set(newDocRef, item);
                        });
                        await newBatch.commit();

                        statusMessage.textContent = `Menu uploaded successfully! Added ${menuData.length} items.`;
                        // Immediately reload menu edit table to reflect new data
                        document.getElementById('loadMenuButton').click();
                    } catch (parseError) {
                        console.error("Error parsing JSON file:", parseError);
                        statusMessage.textContent = `Error parsing JSON file: ${parseError.message}`;
                    }
                };
                fileReader.readAsText(file);
            } catch (error) {
                console.error("Error uploading menu:", error);
                statusMessage.textContent = `Error uploading menu: ${error.message}`;
            }
        });

        // Delete the entire menu from Firestore
        deleteButton.addEventListener('click', async () => {
            if (!db || !auth.currentUser) {
                statusMessage.textContent = 'You must be logged in as admin.';
                return;
            }

            try {
                statusMessage.textContent = 'Deleting menu...';
                const menuRef = collection(db, `artifacts/${appId}/public/data/menu_data`);
                const existingDocs = await getDocs(menuRef);
                const deleteBatch = writeBatch(db);
                existingDocs.forEach((doc) => {
                    deleteBatch.delete(doc.ref);
                });
                await deleteBatch.commit();
                statusMessage.textContent = 'Menu deleted successfully!';
                // Immediately reload menu edit table to reflect deletion
                document.getElementById('loadMenuButton').click();
            } catch (error) {
                console.error("Error deleting menu:", error);
                statusMessage.textContent = `Error deleting menu: ${error.message}`;
            }
        });
    </script>
</body>
</html>